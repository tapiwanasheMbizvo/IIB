BROKER SCHEMA COMMON

CREATE PROCEDURE getDRandCRAccounts(IN OBIMSG REFERENCE, OUT CREDITACC CHARACTER, OUT DEBITACC CHARACTER )BEGIN
 IF OBI_CHARGE_CODES_CACHE.OBICHARGE.FEEID IS NULL THEN
 	
	CALL loadCACHE();
 
 END IF;

SET CREDITACC = THE (SELECT ITEM O.GLACCOUNT FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE  O.CHARGECODE =  OBIMSG.FRONT_END_TRANSACTION_TYPE AND O.BINPRIFIX=OBIMSG.ACQUIRER_BIN);

SET DEBITACC = THE (SELECT ITEM O.SOURCEACCOUNT FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE  O.CHARGECODE =  OBIMSG.FRONT_END_TRANSACTION_TYPE AND O.BINPRIFIX=OBIMSG.ACQUIRER_BIN);

IF CREDITACC IS NULL THEN 
	SET CREDITACC = THE (SELECT ITEM O.GLACCOUNT FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE  O.CHARGECODE =  OBIMSG.FRONT_END_TRANSACTION_TYPE AND O.BINPRIFIX='DEFAULT');
END IF ;

IF DEBITACC IS NULL THEN
	
	SET DEBITACC = THE (SELECT ITEM O.SOURCEACCOUNT FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE  O.CHARGECODE =  OBIMSG.FRONT_END_TRANSACTION_TYPE AND O.BINPRIFIX='DEFAULT');
	
END IF;		


--LETS NOW CHECK FOR THE ACQUIRERPOS,ACQUIRERACC, TERMINALACC AND OTHER NON NUMERIC THINGIES  IN THE DEBIT ACCOUNT 
IF DEBITACC = 'ACQUIRERPOS' THEN 

ELSEIF DEBITACC = 'ACQUIRERACC' THEN 

ELSEIF DEBITACC = 'TERMINALACC' THEN
	
ELSEIF DEBITACC = 'ACQUIRERATM' THEN	

ELSEIF DEBITACC = 'CARDACQUIRER' THEN 
	
ELSEIF DEBITACC = 'CONTITERM' THEN
	
END IF;		

--end chekcs for no numeric for DEBIT 

END;



CREATE PROCEDURE  setOBITramsacionCode(IN CHARGECODE CHARACTER, IN BINPREFIX CHARACTER, IN CRDR CHARACTER ) RETURNS CHARACTER BEGIN
IF TERMINAL_CACHE.TERMINAL.TERMINALID IS NULL THEN
 -- load the cache

 
CALL loadCACHE();

 END IF;
 	
DECLARE TXNCODE CHARACTER;
IF CRDR='CR' THEN
	SET TXNCODE = THE(SELECT ITEM O.CREDITCODE FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE O.BINPRIFIX= BINPREFIX AND O.CHARGECODE=CHARGECODE);
	IF TXNCODE IS  NULL THEN
		SET	TXNCODE =THE(SELECT ITEM O.CREDITCODE FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE O.BINPRIFIX= 'DEFAULT' AND O.CHARGECODE=CHARGECODE);
	END IF;	
ELSE
	SET TXNCODE = THE(SELECT ITEM O.DEBITCODE FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE O.BINPRIFIX= BINPREFIX AND O.CHARGECODE=CHARGECODE);
	IF TXNCODE IS  NULL THEN
		SET	TXNCODE =THE(SELECT ITEM O.DEBITCODE FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE O.BINPRIFIX= 'DEFAULT' AND O.CHARGECODE=CHARGECODE);
	END IF;	
END IF;		

RETURN TXNCODE;
			
END;
 