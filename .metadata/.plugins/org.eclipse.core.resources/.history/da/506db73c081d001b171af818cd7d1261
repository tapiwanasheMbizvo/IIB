BROKER SCHEMA COMMON
CREATE PROCEDURE  getISBULKED( IN CHARGECODE CHARACTER ) RETURNS CHARACTER BEGIN

 IF OBI_CHARGE_CODES_CACHE.OBICHARGE.FEEID IS NULL THEN
 -- load the cache
	CALL loadCACHE();
 
 END IF;	
	
RETURN 	CAST (THE (SELECT ITEM O.IS_BULKED FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE  O.CHARGECODE =  CHARGECODE  )AS CHARACTER);

END;

CREATE PROCEDURE getOBIAccounts(IN OBIMSG REFERENCE, OUT CREDITACC CHARACTER, OUT DEBITACC CHARACTER )BEGIN 

 IF TERMINAL_CACHE.TERMINAL.TERMINALID IS NULL THEN
 -- load the cache

 
CALL loadCACHE();

 END IF;
 
 DECLARE OBIGL, DEBIT_CREDIT_INDICATOR, CHARGECODE, BIN_PREFIX, AQUIRERID, ISO_TERMINAL_ID, DEFAULT_CREDIT_GL CHARACTER;

SET DEBIT_CREDIT_INDICATOR = OBIMSG.DEBIT_CREDIT_INDICATOR;
SET CHARGECODE =  OBIMSG.FRONT_END_TRANSACTION_TYPE;
--SET ISO_TERMINAL_ID = OBIMSG.ISO_TERMINAL_ID;
SET BIN_PREFIX =  LEFT (OBIMSG.OPTIONAL_1,6);
SET AQUIRERID =  OBIMSG.ACQUIRER_BIN;
SET DEFAULT_CREDIT_GL= '4371110189217';

SET OBIGL = THE (SELECT ITEM O.GLACCOUNT FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE  O.CHARGECODE =  CHARGECODE AND O.DRCR=DEBIT_CREDIT_INDICATOR AND O.BINPRIFIX =BIN_PREFIX); 	
IF OBIGL IS NULL THEN 
	SET OBIGL =	THE (SELECT ITEM O.GLACCOUNT FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE  O.CHARGECODE =  CHARGECODE AND O.DRCR=DEBIT_CREDIT_INDICATOR );
	
END IF;	 
---- START

IF OBIMSG.FRONT_END_TRANSACTION_TYPE  ='TPTP785' AND LENGTH( OBIMSG.OPTIONAL_1)>5    THEN 
						--Acquirer acquirer2 = em.find(Acquirer.class, rc.getOptional1().substring(0, 6).trim());
						--acquirer = em.find(Acquirer.class, rc.getAcquirerBin().trim());
						--Terminal term = em.find(Terminal.class, rc.getIsoTerminalID().trim());
						
		SET ISO_TERMINAL_ID = THE(SELECT ITEM T.TERMINALID FROM TERMINAL_CACHE.TERMINAL[] AS T WHERE T.TERMINALID = OBIMSG.ISO_TERMINAL_ID);
		IF ISO_TERMINAL_ID IS NOT NULL THEN 
		
		END IF ;	
						
END IF ;	
---- END  
IF OBIMSG.FRONT_END_TRANSACTION_TYPE = 'TPTP785' THEN
	
				SET DEBITACC = DEFAULT_CREDIT_GL;
				SET CREDITACC = THE(SELECT ITEM T.ACCOUNTNO FROM TERMINAL_CACHE.TERMINAL[] AS T WHERE T.TERMINALID = ISO_TERMINAL_ID);
				 
			ELSEIF OBIMSG.FRONT_END_TRANSACTION_TYPE = 'FEEG37' THEN --debit gl , credit acquirerPOS account 
		
				SET DEBITACC = DEFAULT_CREDIT_GL;
				SET CREDITACC = THE(SELECT ITEM A.POSACCOUNT FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID); 	
			
			ELSEIF OBIMSG.FRONT_END_TRANSACTION_TYPE = 'FEED934' THEN ---- them on us purchase , debit acquirer account , credit terminal account 
			
			SET DEBITACC = THE(SELECT ITEM A.POSACCOUNT FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);	
			SET CREDITACC = THE(SELECT ITEM T.ACCOUNTNO FROM TERMINAL_CACHE.TERMINAL[] AS T WHERE T.TERMINALID = ISO_TERMINAL_ID);
			
			ELSEIF OBIMSG.FRONT_END_TRANSACTION_TYPE = 'FEED331' THEN	---debit acquirer account, credit terminal account 
			
			SET DEBITACC = THE(SELECT ITEM A.POSACCOUNT FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);	
			SET CREDITACC = THE(SELECT ITEM T.ACCOUNTNO FROM TERMINAL_CACHE.TERMINAL[] AS T WHERE T.TERMINALID = ISO_TERMINAL_ID);
				
			ELSE 
				SET DEBITACC = THE(SELECT ITEM A.POSACCOUNT FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);	
				SET CREDITACC = THE(SELECT ITEM T.ACCOUNTNO FROM TERMINAL_CACHE.TERMINAL[] AS T WHERE T.TERMINALID = ISO_TERMINAL_ID);
			
		
END IF;	

END;	


CREATE PROCEDURE  setAccounts(IN OBIMSG REFERENCE, OUT CREDITACC CHARACTER, OUT DEBITACC CHARACTER )BEGIN
 IF TERMINAL_CACHE.TERMINAL.TERMINALID IS NULL THEN
 -- load the cache

 
CALL loadCACHE();

 END IF;

 DECLARE OBIGL, DEBIT_CREDIT_INDICATOR, CHARGECODE, BIN_PREFIX, AQUIRERID, ISO_TERMINAL_ID, DEFAULT_CREDIT_GL CHARACTER;

SET DEBIT_CREDIT_INDICATOR = OBIMSG.DEBIT_CREDIT_INDICATOR;
SET CHARGECODE =  OBIMSG.FRONT_END_TRANSACTION_TYPE;
SET ISO_TERMINAL_ID = OBIMSG.ISO_TERMINAL_ID;
SET BIN_PREFIX = LEFT (OBIMSG.ACCOUNT_NUMBER,9);
SET AQUIRERID =  OBIMSG.ACQUIRER_BIN;
SET DEFAULT_CREDIT_GL= '4371110189217';

SET OBIGL = THE (SELECT ITEM O.GLACCOUNT FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE  O.CHARGECODE =  CHARGECODE AND O.DRCR=DEBIT_CREDIT_INDICATOR AND O.BINPRIFIX =BIN_PREFIX); 	
IF OBIGL IS NULL THEN 
	SET OBIGL =	THE (SELECT ITEM O.GLACCOUNT FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE  O.CHARGECODE =  CHARGECODE AND O.DRCR=DEBIT_CREDIT_INDICATOR );
	
END IF;	


IF OBIGL = 'SOURCEACCOUNT' THEN -- debit source account and credit  ACQUIRER POS ACCOUNT
	SET DEBITACC = OBIMSG.ACCOUNT_NUMBER;
	SET CREDITACC = THE(SELECT ITEM A.POSACCOUNT FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);
	
ELSEIF OBIGL = 'TERMINALACC' THEN  -- debit Terminal Account Number , to get credit account 	
	SET DEBITACC = THE(SELECT ITEM T.ACCOUNTNO FROM TERMINAL_CACHE.TERMINAL[] AS T WHERE T.TERMINALID = ISO_TERMINAL_ID);
	SET CREDITACC = DEFAULT_CREDIT_GL; --MISSING FROM DOC
	
ELSEIF OBIGL ='ACQUIRERPOS'	THEN --DEBIT ACQUIRER POS ACCOUNT  , to get credit account logic  
	SET DEBITACC = THE(SELECT ITEM A.POSACCOUNT FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);
	SET CREDITACC = DEFAULT_CREDIT_GL; -- TO BE CONFIRMED MISSING FROM DOC
	
ELSEIF OBIGL = 'ACQUIRERACC' OR OBIGL = 'ACQUIRERATM' THEN  --DEBIT Acquirer Account POS or ATM
		
			--ACQUIRERACC/ACQUIRERATM
	--SET DEBITACC	
	IF OBIGL ='ACQUIRERACC' THEN
			SET DEBITACC = 	 THE(SELECT ITEM A.ACCOUNTNO FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);
		ELSE
			SET DEBITACC = 	 THE(SELECT ITEM A.ATMACCOUNT FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);
	END IF;			
	SET CREDITACC = DEFAULT_CREDIT_GL; -- 
	
ELSEIF OBIGL = 'CARDACQUIRER' THEN --DEBIT Acquirer Account
	
	SET DEBITACC = THE(SELECT ITEM A.ACCOUNTNO FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);
	SET CREDITACC = DEFAULT_CREDIT_GL;
		
ELSEIF OBIGL = '589003237' OR OBIGL ='589003233' OR OBIGL='589003235' THEN --4131802300932 DEBIT ACCOUNT
--	When POS use
--4131901686932
--Otherwise if ATM use
--4131904060932
--else use terminal account
--Number FOR CREDIT
	SET DEBITACC ='4131802300932';
	SET CREDITACC ='4131901686932'; -- TO GET LOGIC ON HOW TO SEE IF IT IS A POS OR ATM 
			

ELSEIF OBIGL = '589003239' AND CHARGECODE = 'TPTP712' THEN --DEBIT Terminal Account Numbe
	SET DEBITACC = THE(SELECT ITEM T.ACCOUNTNO FROM TERMINAL_CACHE.TERMINAL[] AS T WHERE T.TERMINALID = ISO_TERMINAL_ID);
	SET CREDITACC = '4371110189217';
		IF DEBITACC IS NULL OR CREDITACC IS NULL THEN
			SET DEBITACC = THE(SELECT ITEM A.ACCOUNTNO FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);
			SET CREDITACC =  '4371110189217';
		END IF;	

ELSEIF OBIGL =	'589003239' AND CHARGECODE = 'TPTP774' OR CHARGECODE = 'TPTP776' OR CHARGECODE='TPTP777' THEN 
	SET DEBITACC = '4371110189217';
	SET CREDITACC =	THE(SELECT ITEM T.ACCOUNTNO FROM TERMINAL_CACHE.TERMINAL[] AS T WHERE T.TERMINALID = ISO_TERMINAL_ID);
	
		IF DEBITACC IS NULL OR CREDITACC IS NULL THEN
			SET DEBITACC = '4371110189217';
			SET CREDITACC = THE(SELECT ITEM A.ACCOUNTNO FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);
		END IF;	

	

ELSEIF LEFT(CHARGECODE, 4)= 'TPTP'  THEN -- --REQUIRES FURTHER REFINEMENT REFER TO DOCS
	SET DEBITACC = THE(SELECT ITEM T.ACCOUNTNO FROM TERMINAL_CACHE.TERMINAL[] AS T WHERE T.TERMINALID = ISO_TERMINAL_ID);
	SET CREDITACC = THE(SELECT ITEM A.ACCOUNTNO FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);
		--Starts with TPTP and OBI
--GL Bin prefix = DEFAULT

ELSEIF CHARGECODE ='FEEC170'  THEN
	
	SET DEBITACC = '4131900885932';
	SET CREDITACC = '4131841410932';

ELSEIF 	CHARGECODE ='FEEG37' THEN
	SET DEBITACC = '4131901640932';
	SET CREDITACC = THE(SELECT ITEM A.POSACCOUNT FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);

ELSEIF CHARGECODE='TPTP785' THEN 
	SET DEBITACC = THE(SELECT ITEM A.POSACCOUNT FROM ACQUIRER_ACCUNTS_CACHE.ACQUIRER[] AS A WHERE A.ID = AQUIRERID);
	SET CREDITACC = OBIGL;	

ELSEIF OBIGL= '543948131'OR OBIGL='543948132' OR OBIGL= '543948133' OR OBIGL='543948134' AND CHARGECODE='FEED320' OR CHARGECODE='FEED321' THEN
	SET DEBITACC = '4131841410932';
	SET CREDITACC = '4131900896932';

ELSEIF CHARGECODE ='412636133' OR CHARGECODE='412638134' THEN 	
	SET DEBITACC = '4131841420840';
	SET CREDITACC = THE(SELECT ITEM T.ACCOUNTNO FROM TERMINAL_CACHE.TERMINAL[] AS T WHERE T.TERMINALID = ISO_TERMINAL_ID);

ELSEIF OBIGL IS NOT NULL AND LEFT (CHARGECODE, 3)='FEE' THEN
	
	SET DEBITACC = OBIGL;
	SET CREDITACC = DEFAULT_CREDIT_GL;	
END IF;	
 ---		 	
 
 IF OBIMSG.FRONT_END_TRANSACTION_TYPE = 'TPTP785' THEN
				 
			ELSEIF OBIMSG.FRONT_END_TRANSACTION_TYPE = 'FEEG37' THEN 
			
			
			ELSEIF OBIMSG.FRONT_END_TRANSACTION_TYPE = 'FEED934' THEN
				
			
			ELSEIF OBIMSG.FRONT_END_TRANSACTION_TYPE = 'FEED331' THEN	
			END IF;		 	
END;

CREATE PROCEDURE  setOBITramsacionCode(IN CHARGECODE CHARACTER, IN BINPREFIX CHARACTER, IN CRDR CHARACTER ) RETURNS CHARACTER BEGIN
IF TERMINAL_CACHE.TERMINAL.TERMINALID IS NULL THEN
 -- load the cache

 
CALL loadCACHE();

 END IF;
 	
DECLARE TXNCODE CHARACTER;
IF CRDR='CR' THEN
	SET TXNCODE = THE(SELECT ITEM O.CREDITCODE FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE O.BINPRIFIX= BINPREFIX AND O.CHARGECODE=CHARGECODE);
	IF TXNCODE IS  NULL THEN
		SET	TXNCODE =THE(SELECT ITEM O.CREDITCODE FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE O.BINPRIFIX= 'DEFAULT' AND O.CHARGECODE=CHARGECODE);
	END IF;	
ELSE
	SET TXNCODE = THE(SELECT ITEM O.DEBITCODE FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE O.BINPRIFIX= BINPREFIX AND O.CHARGECODE=CHARGECODE);
	IF TXNCODE IS  NULL THEN
		SET	TXNCODE =THE(SELECT ITEM O.DEBITCODE FROM OBI_CHARGE_CODES_CACHE.OBICHARGE[] AS O WHERE O.BINPRIFIX= 'DEFAULT' AND O.CHARGECODE=CHARGECODE);
	END IF;	
END IF;		

RETURN TXNCODE;
			
END;



